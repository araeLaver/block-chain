name: ğŸ“ˆ í”„ë¡œì íŠ¸ í†µê³„

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìì •
  workflow_dispatch:

jobs:
  update-stats:
    name: í”„ë¡œì íŠ¸ í†µê³„ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“Š í”„ë¡œì íŠ¸ í†µê³„ ìƒì„±
        run: |
          echo "# ğŸ“Š í”„ë¡œì íŠ¸ í†µê³„" > PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md
          echo "> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S KST')" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md

          echo "## ğŸ“ ì½”ë“œ í†µê³„" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md

          # ì´ ë¼ì¸ ìˆ˜
          TOTAL_LINES=$(find . -name "*.js" -o -name "*.sol" -o -name "*.jsx" -o -name "*.md" | xargs wc -l | tail -1 | awk '{print $1}')
          echo "- **ì´ ë¼ì¸ ìˆ˜**: $(printf "%'d" $TOTAL_LINES)" >> PROJECT_STATS.md

          # JavaScript íŒŒì¼
          if [ -n "$(find . -name "*.js" -o -name "*.jsx")" ]; then
            JS_LINES=$(find . -name "*.js" -o -name "*.jsx" | xargs wc -l | tail -1 | awk '{print $1}')
            JS_FILES=$(find . -name "*.js" -o -name "*.jsx" | wc -l)
            echo "- **JavaScript íŒŒì¼**: $JS_FILES ê°œ ($(printf "%'d" $JS_LINES) ì¤„)" >> PROJECT_STATS.md
          fi

          # Solidity íŒŒì¼
          if [ -n "$(find . -name "*.sol")" ]; then
            SOL_LINES=$(find . -name "*.sol" | xargs wc -l | tail -1 | awk '{print $1}')
            SOL_FILES=$(find . -name "*.sol" | wc -l)
            echo "- **Solidity íŒŒì¼**: $SOL_FILES ê°œ ($(printf "%'d" $SOL_LINES) ì¤„)" >> PROJECT_STATS.md
          fi

          # Markdown íŒŒì¼
          if [ -n "$(find . -name "*.md")" ]; then
            MD_LINES=$(find . -name "*.md" | xargs wc -l | tail -1 | awk '{print $1}')
            MD_FILES=$(find . -name "*.md" | wc -l)
            echo "- **ë¬¸ì„œ íŒŒì¼**: $MD_FILES ê°œ ($(printf "%'d" $MD_LINES) ì¤„)" >> PROJECT_STATS.md
          fi

          echo "" >> PROJECT_STATS.md

          echo "## ğŸ”„ Git í†µê³„" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md

          TOTAL_COMMITS=$(git rev-list --count HEAD)
          echo "- **ì´ ì»¤ë°‹ ìˆ˜**: $TOTAL_COMMITS" >> PROJECT_STATS.md

          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          echo "- **ê¸°ì—¬ì ìˆ˜**: $CONTRIBUTORS" >> PROJECT_STATS.md

          FIRST_COMMIT_DATE=$(git log --reverse --format='%ai' | head -1 | cut -d' ' -f1)
          echo "- **í”„ë¡œì íŠ¸ ì‹œì‘**: $FIRST_COMMIT_DATE" >> PROJECT_STATS.md

          DAYS_SINCE_START=$(( ($(date +%s) - $(date -d "$FIRST_COMMIT_DATE" +%s)) / 86400 ))
          echo "- **í”„ë¡œì íŠ¸ ì§„í–‰**: $DAYS_SINCE_START ì¼" >> PROJECT_STATS.md

          echo "" >> PROJECT_STATS.md

          echo "## ğŸ‘¥ ìƒìœ„ ê¸°ì—¬ì" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md
          echo "| ìˆœìœ„ | ì´ë¦„ | ì»¤ë°‹ ìˆ˜ |" >> PROJECT_STATS.md
          echo "|------|------|---------|" >> PROJECT_STATS.md
          git log --format='%aN' | sort | uniq -c | sort -rn | head -5 | awk '{printf "| %d | %s | %d |\n", NR, $2, $1}' >> PROJECT_STATS.md

          echo "" >> PROJECT_STATS.md

          echo "## ğŸ“… ìµœê·¼ í™œë™ (ìµœê·¼ 10ê°œ ì»¤ë°‹)" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md
          echo "| ë‚ ì§œ | ì»¤ë°‹ ë©”ì‹œì§€ | ì‘ì„±ì |" >> PROJECT_STATS.md
          echo "|------|------------|--------|" >> PROJECT_STATS.md
          git log -10 --pretty=format:'| %ad | %s | %an |' --date=short >> PROJECT_STATS.md

          echo "" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md

          echo "## ğŸ“‚ ë””ë ‰í† ë¦¬ êµ¬ì¡°" >> PROJECT_STATS.md
          echo "" >> PROJECT_STATS.md
          echo '```' >> PROJECT_STATS.md
          tree -L 3 -I 'node_modules|.git|cache|artifacts' || find . -type d -not -path '*/node_modules/*' -not -path '*/.git/*' -not -path '*/cache/*' -not -path '*/artifacts/*' | head -30
          echo '```' >> PROJECT_STATS.md

      - name: ğŸ“¤ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT_STATS.md

          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "ìë™ ìƒì„±: í”„ë¡œì íŠ¸ í†µê³„ ì—…ë°ì´íŠ¸ ğŸ“Š"
            git push
          fi
